<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal Adzan Simple</title>
    <style>
        /* CSS DIBUAT MINIMALIS UNTUK FOKUS PADA FUNGSIONALITAS */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #004d40;
            color: #ffffff;
            text-align: center;
        }
        .box-adzan-simple {
            border: 2px solid #ffeb3b;
            border-radius: 15px;
            padding: 20px;
            background-color: #002d25;
            max-width: 300px;
            margin: 20px auto 10px auto; /* Tambah margin atas/bawah */
        }
        #countdown-simple {
            font-size: 24px;
            font-weight: bold;
            margin: 15px 0;
            background-color: #4CAF50;
            padding: 10px;
            border-radius: 8px;
        }
        #jadwal-simple {
            font-size: 16px;
            margin-top: 15px;
            line-height: 1.5;
            color: #ffeb3b;
        }
        .judul-kecil {
            font-size: 14px;
            color: #b2dfdb;
        }
        /* CSS Wajib untuk Tombol Play Manual (AGAR MUNCUL) */
        #btnPlay-simple {
            background-color: #ffeb3b;
            color: #004d40;
            border: none;
            padding: 10px 20px; /* Diperbesar agar mudah diklik */
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
            transition: background-color 0.2s;
            display: block; /* Pastikan tombol mengambil lebar penuh container */
            width: 300px; /* Samakan dengan max-width widget */
            margin: 0 auto; /* Posisi di tengah */
        }
        #btnPlay-simple:hover {
            background-color: #fff176;
        }
    </style>
</head>
<body>

<div class="box-adzan-simple">
    <h2>üïå Jadwal Adzan</h2>
    <div class="judul-kecil">(Test JSON Simple)</div>
    
    <div id="countdown-simple">
        Memuat...
    </div>

    <div id="jadwal-simple">
        Memuat data jadwal...
    </div>
</div>

<button id="btnPlay-simple">‚ñ∂Ô∏è Aktifkan Suara / Putar Manual</button>

<audio id="audioSimple" preload="auto"></audio>

<script>
    // --- KONFIGURASI PENTING ---
    const PRAYER_ORDER = ["Subuh", "Dzuhur", "Ashar", "Maghrib", "Isya"];
    
    // --- PATH FILE AUDIO LOKAL ANDA ---
    const ADZAN_NORMAL_PATH = 'adzan.mp3';
    const ADZAN_SUBUH_PATH = 'adzan_subuh.mp3';
    
    // --- VARIABEL GLOBAL & ELEMENT ---
    let countdownIntervalSimple;
    const countdownDivSimple = document.getElementById('countdown-simple');
    const jadwalDivSimple = document.getElementById('jadwal-simple');
    const audioSimple = document.getElementById('audioSimple');
    const btnPlaySimple = document.getElementById('btnPlay-simple');
    
    window.prayerTimesSimple = {};
    window.prayerDateSimple = new Date(); 

    // --- JADWAL DEFAULT (Fallback Jika File JSON Gagal) ---
    const defaultPrayerTimes = {
        "Subuh": "04:05", "Dzuhur": "11:38", "Ashar": "14:59",
        "Maghrib": "17:50", "Isya": "19:00" 
    };

    // --- UTILITY FUNCTIONS ---

    function useDefaultJadwal() {
        window.prayerTimesSimple = defaultPrayerTimes;
        window.prayerDateSimple = new Date();
        jadwalDivSimple.innerHTML = `
            <span style="color: red; font-weight: bold;">(JADWAL DEFAULT - GAGAL MEMUAT)</span><br>
            Tanggal: <strong>Gagal memuat jadwal lokal!</strong><br>
            Subuh : 04:05<br>
            Dzuhur : 11:38<br>
            Ashar : 14:59<br>
            Maghrib : 17:50<br>
            Isya : 19:00
        `;
    }

    function findScheduleByDate(scheduleArray, targetDate) {
        const targetDateStr = targetDate.toISOString().split("T")[0];
        return scheduleArray.find(item => item.date === targetDateStr);
    }
    
    function getNextPrayerTimesSimple(date, times) {
        const now = new Date();
        const dateStr = date.toISOString().split("T")[0]; 
        const nextTimes = [];
        
        for (const name of PRAYER_ORDER) {
            const timeStr = times[name]; 
            if (!timeStr) continue; 
            
            const prayerDateTime = new Date(`${dateStr}T${timeStr}:00`);
            
            if (prayerDateTime.getTime() > now.getTime()) { 
                nextTimes.push({ name, time: prayerDateTime });
                break; 
            }
        }
        return nextTimes;
    }
    
    function playAdzanSimple(isSubuh = false) {
        audioSimple.src = isSubuh ? ADZAN_SUBUH_PATH : ADZAN_NORMAL_PATH;
        audioSimple.load();
        
        audioSimple.play().catch(error => {
            console.warn("Gagal memutar audio, mungkin diblokir oleh browser:", error);
            btnPlaySimple.innerHTML = "‚ùå Klik Dulu untuk Mengaktifkan Suara Otomatis!";
        });
    }


    function startCountdownSimple() {
        if (countdownIntervalSimple) clearInterval(countdownIntervalSimple);
        
        if (Object.keys(window.prayerTimesSimple).length === 0) {
            countdownDivSimple.innerHTML = "Error: Data sholat kosong.";
            return;
        }

        countdownIntervalSimple = setInterval(function() {
            const now = new Date().getTime();
            const nextPrayers = getNextPrayerTimesSimple(window.prayerDateSimple, window.prayerTimesSimple);
            
            // KASUS 1: Semua sholat sudah usai (setelah Isya)
            if (nextPrayers.length === 0) {
                countdownDivSimple.innerHTML = "Semua sholat telah usai. Memuat jadwal besok...";
                clearInterval(countdownIntervalSimple);
                setTimeout(loadJadwalSimple, 3000); 
                return;
            }
            
            const nextPrayer = nextPrayers[0];
            const nextName = nextPrayer.name;
            const nextTime = nextPrayer.time.getTime();
            
            const diff = nextTime - now;

            // KASUS 2: Waktu Sholat Tiba (Diff sangat dekat 0)
            if (diff <= 1000 && diff > -1000) { 
                
                // Putar Adzan
                const isSubuh = (nextName === "Subuh");
                playAdzanSimple(isSubuh);
                
                countdownDivSimple.innerHTML = `‚≠ê ADZAN ${nextName} Tiba! ‚≠ê`;
                
                clearInterval(countdownIntervalSimple);
                // Muat ulang jadwal setelah jeda Adzan 3 menit (180000 ms)
                setTimeout(loadJadwalSimple, 180000); 
                return;
            }
            
            // KASUS 3: Hitungan Mundur Normal
            let hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            let minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            let seconds = Math.floor((diff % (1000 * 60)) / 1000);

            hours = ("0" + hours).slice(-2);
            minutes = ("0" + minutes).slice(-2);
            seconds = ("0" + seconds).slice(-2);

            countdownDivSimple.innerHTML = `Menuju ${nextName}: ${hours}:${minutes}:${seconds}`;

        }, 1000);
    }

    async function loadJadwalSimple() {
        const now = new Date(); 
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); 
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);

        if (countdownIntervalSimple) clearInterval(countdownIntervalSimple);
        countdownDivSimple.innerHTML = "Memuat...";

        let rawSchedule;
        let success = false;
        let dataToUse; 
        let dateToUse = today; 

        try {
            const res = await fetch('jadwal.json'); 
            if (!res.ok) throw new Error(`Status: ${res.status}`);
            
            rawSchedule = await res.json();
            const todayData = findScheduleByDate(rawSchedule.schedule, today);
            
            if (todayData) {
                const tempTimes = {
                    "Subuh": todayData.Subuh, "Dzuhur": todayData.Dzuhur, "Ashar": todayData.Ashar,
                    "Maghrib": todayData.Maghrib, "Isya": todayData.Isya
                };

                const nextTodayPrayers = getNextPrayerTimesSimple(today, tempTimes);

                if (nextTodayPrayers.length > 0) {
                    dataToUse = todayData;
                    dateToUse = today;
                    success = true;
                } else {
                    const nextData = findScheduleByDate(rawSchedule.schedule, tomorrow);
                    if (nextData) {
                        dataToUse = nextData;
                        dateToUse = tomorrow;
                        success = true;
                    } else {
                        throw new Error("Jadwal hari ini sudah lewat dan jadwal besok tidak ditemukan.");
                    }
                }
            } else {
                throw new Error("Jadwal hari ini tidak ditemukan di file JSON.");
            }
            
        } catch (error) {
            console.error("Error memuat JSON:", error);
            jadwalDivSimple.innerHTML = `<span style="color: red; font-weight: bold;">‚ùå Gagal Memuat Jadwal! Error: ${error.message}</span>`;
            success = false;
        }

        if (!success) {
            useDefaultJadwal();
            setTimeout(startCountdownSimple, 100); 
            return; 
        }
        
        // DATA DITEMUKAN & DIPILIH
        jadwalDivSimple.innerHTML = `
            <span style="font-weight: bold;">Jadwal Tanggal: ${dataToUse.date}</span><br>
            Subuh : ${dataToUse.Subuh}<br>
            Dzuhur : ${dataToUse.Dzuhur}<br>
            Ashar : ${dataToUse.Ashar}<br>
            Maghrib : ${dataToUse.Maghrib}<br>
            Isya : ${dataToUse.Isya}
        `;

        window.prayerTimesSimple = {
            "Subuh": dataToUse.Subuh,
            "Dzuhur": dataToUse.Dzuhur,
            "Ashar": dataToUse.Ashar,
            "Maghrib": dataToUse.Maghrib,
            "Isya": dataToUse.Isya
        };
        window.prayerDateSimple = dateToUse; 

        setTimeout(startCountdownSimple, 100); 
    }
    
    // --- EVENT LISTENER (Play Manual) ---
    btnPlaySimple.addEventListener('click', function() {
        const nextPrayers = getNextPrayerTimesSimple(window.prayerDateSimple, window.prayerTimesSimple);
        let isSubuh = false; 

        if (nextPrayers.length > 0 && nextPrayers[0].name === "Subuh") {
            isSubuh = true;
        }

        playAdzanSimple(isSubuh);
        btnPlaySimple.innerHTML = "‚úÖ Suara Diaktifkan!";
    });

    // --- INITIALIZATION ---
    loadJadwalSimple();
</script>

</body>
</html>
