<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal Adzan</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: transparent; /* Pastikan background transparan untuk widget */
        }
        .box-adzan-simple {
            width: 100%;
            max-width: 300px; 
            background: linear-gradient(145deg, #004d40, #002d25); 
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
            padding: 20px;
            text-align: center;
            color: #ffffff;
            border: 2px solid #ffeb3b;
        }
        .title-simple {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #ffeb3b;
            text-shadow: 1px 1px 2px #000;
        }
        .keterangan-muhammadiyah {
            font-size: 14px; 
            font-weight: 500;
            color: #ffeb3b; 
            margin-top: -15px; 
            margin-bottom: 10px;
        }
        #countdown-simple {
            font-size: 22px;
            font-weight: 700;
            background-color: rgba(255, 255, 255, 0.15);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            white-space: nowrap;
        }
        #jadwal-simple {
            font-size: 16px;
            line-height: 1.8;
            background: rgba(255, 215, 0, 0.1); 
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
            margin-bottom: 20px;
            color: #ffeb3b;
            text-align: center; /* Perbaikan Alignment */
        }
        .voice-selector-simple {
            font-size: 14px;
            margin-bottom: 15px;
            color: #b2dfdb;
        }
        .select-simple {
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ffeb3b;
            background-color: #004d40;
            color: #ffffff;
            cursor: pointer;
        }
        .btn-play-simple {
            background-color: #ffeb3b;
            color: #004d40;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .btn-play-simple:hover {
            background-color: #fff176;
        }
    </style>
</head>
<body>

<div class="box-adzan-simple">
    <div class="title-simple">
        <span style="font-size: 20px; vertical-align: middle;">üïå</span> 
        Jadwal Adzan
    </div>
    <div class="keterangan-muhammadiyah">
        (Untuk warga Muhammadiyah)
    </div>

    <div id="countdown-simple">
        Memuat...
    </div>

    <div class="voice-selector-simple">
        Pilih suara adzan:
        <select id="voiceSelect-simple" class="select-simple">
            <option 
                value="https://www.islamcan.com/audio/adhan/azan1.mp3" 
                data-subuh="adzan-subuh-merdu.mp3" 
                selected>Makkah
            </option>
            <option 
                value="https://www.islamcan.com/audio/adhan/azan2.mp3" 
                data-subuh="adzan-subuh-merdu.mp3"
                >Madinah
            </option>
        </select>
        <button id="btnPlay-simple" class="btn-play-simple">‚ñ∂Ô∏è Putar Adzan</button>
    </div>

    <div id="jadwal-simple">
        Memuat jadwal dari file lokal...
    </div>
</div>

<audio id="audioSimple" preload="auto"></audio>

<script>
    // --- KONFIGURASI UMUM ---
    const KOTA_NAMA = "Sleman (Yogyakarta)";
    // Daftar waktu sholat yang digunakan dalam iterasi
    const PRAYER_ORDER = ["Subuh", "Dzuhur", "Ashar", "Maghrib", "Isya"]; 
    
    // --- VARIABEL GLOBAL & ELEMENT ---
    let countdownIntervalSimple;
    const countdownDivSimple = document.getElementById('countdown-simple');
    const jadwalDivSimple = document.getElementById('jadwal-simple');
    const audioSimple = document.getElementById('audioSimple');
    const voiceSelectSimple = document.getElementById('voiceSelect-simple');
    const btnPlaySimple = document.getElementById('btnPlay-simple');
    
    window.prayerTimesSimple = {};
    window.prayerDateSimple = new Date(); // Untuk menyimpan tanggal jadwal yang aktif
    
    // --- JADWAL DEFAULT (Fallback Jika File JSON Gagal) ---
    const defaultPrayerTimes = {
        "Subuh": "04:05", "Dzuhur": "11:38", "Ashar": "14:59",
        "Maghrib": "17:50", "Isya": "19:00" 
    };

    // --- UTILITY FUNCTIONS ---

    function useDefaultJadwal() {
        window.prayerTimesSimple = defaultPrayerTimes;
        window.prayerDateSimple = new Date();
        jadwalDivSimple.innerHTML = `
            <span style="color: red; font-weight: bold;">(JADWAL DEFAULT)</span><br>
            Tanggal: <strong>Gagal memuat jadwal lokal!</strong><br>
            Subuh : 04:05<br>
            Dzuhur : 11:38<br>
            Ashar : 14:59<br>
            Maghrib : 17:50<br>
            Isya : 19:00
        `;
        countdownDivSimple.innerHTML = "Jadwal darurat dimuat.";
    }

    // Fungsi untuk mencari jadwal di array JSON yang dimuat
    function findScheduleByDate(scheduleArray, targetDate) {
        // Format tanggal target ke YYYY-MM-DD
        const targetDateStr = targetDate.toISOString().split("T")[0];
        return scheduleArray.find(item => item.date === targetDateStr);
    }
    
    // Fungsi untuk menemukan waktu sholat berikutnya
    function getNextPrayerTimesSimple(date, times) {
        const now = new Date();
        const dateStr = date.toISOString().split("T")[0]; // Tanggal jadwal yang aktif (hari ini atau besok)
        const nextTimes = [];
        
        for (const name of PRAYER_ORDER) {
            const timeStr = times[name]; 
            if (!timeStr) continue; 
            
            // Gabungkan tanggal jadwal dengan waktu sholat
            const prayerDateTime = new Date(`${dateStr}T${timeStr}:00`);
            
            // Cek apakah waktu sholat masih di masa depan
            if (prayerDateTime.getTime() > now.getTime()) { 
                nextTimes.push({ name, time: prayerDateTime });
                break; 
            }
        }

        return nextTimes;
    }

    // Fungsi untuk memutar Adzan
    function playAdzanSimple() {
        audioSimple.play().catch(error => {
            console.warn("Gagal memutar audio, mungkin diblokir oleh browser:", error);
            // Instruksi ke pengguna jika diperlukan
            countdownDivSimple.innerHTML = "Klik 'Putar Adzan' sekali untuk mengaktifkan suara otomatis!";
        });
    }

    // Fungsi utama untuk memulai countdown
    function startCountdownSimple() {
        // Hentikan interval lama jika ada
        if (countdownIntervalSimple) clearInterval(countdownIntervalSimple);
        
        // Atur ulang interval setiap 1 detik
        countdownIntervalSimple = setInterval(function() {
            const now = new Date().getTime();
            const nextPrayers = getNextPrayerTimesSimple(window.prayerDateSimple, window.prayerTimesSimple);
            
            // KASUS 1: Tidak ada sholat hari ini (terjadi setelah Isya)
            if (nextPrayers.length === 0) {
                // Beri pesan dan panggil loadJadwalSimple() untuk memuat jadwal besok
                countdownDivSimple.innerHTML = "Semua sholat hari ini telah usai. Memuat jadwal besok...";
                clearInterval(countdownIntervalSimple);
                // Kita panggil loadJadwalSimple() yang akan mengurus pengambilan data besok
                loadJadwalSimple(); 
                return;
            }
            
            const nextPrayer = nextPrayers[0];
            const nextName = nextPrayer.name;
            const nextTime = nextPrayer.time.getTime();
            
            const diff = nextTime - now;

            // KASUS 2: Waktu Sholat Sudah Tiba (diff sangat dekat 0)
            if (diff <= 1000 && diff > -1000) { 
                
                // 1. Ganti sumber audio khusus Subuh
                let adzanSource = voiceSelectSimple.value;
                let displayMessage = "Adzan Tiba!"; 
                
                if (nextName === "Subuh") {
                    adzanSource = voiceSelectSimple.options[voiceSelectSimple.selectedIndex].getAttribute('data-subuh');
                    displayMessage = "‚òÄÔ∏è Adzan Subuh Tiba! (Sholat lebih baik daripada tidur)";
                }
                
                audioSimple.src = adzanSource;
                audioSimple.load(); 
                playAdzanSimple(); // Putar Adzan
                
                countdownDivSimple.innerHTML = `‚≠ê ${nextName}: ${displayMessage}`;
                
                // 2. Atur timeout untuk menghentikan Adzan (3 MENIT) dan memuat ulang jadwal
                setTimeout(() => {
                    audioSimple.pause(); 
                    // PENTING: loadJadwalSimple() akan memuat ulang jadwal besok/hari ini
                    loadJadwalSimple();¬†
                }, 180000); // 180.000 milidetik = 3 Menit
                
                clearInterval(countdownIntervalSimple);
                return;
            }
            
            // KASUS 3: Waktu Sholat Sudah Lewat (terjadi pada saat refresh)
            if (diff < 0) {
                 // Ini adalah logic pencegah negatif yang sering terjadi
                countdownDivSimple.innerHTML = `‚ö†Ô∏è ${nextName} sudah berlalu! Memuat jadwal...`;
                clearInterval(countdownIntervalSimple);
                loadJadwalSimple(); // Paksa reload untuk menemukan sholat berikutnya yang valid
                return;
            }

            // KASUS 4: Hitungan Mundur Normal
            let hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            let minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            let seconds = Math.floor((diff % (1000 * 60)) / 1000);

            // Format angka menjadi dua digit (e.g., 05)
            hours = ("0" + hours).slice(-2);
            minutes = ("0" + minutes).slice(-2);
            seconds = ("0" + seconds).slice(-2);

            countdownDivSimple.innerHTML = `Menuju Adzan Berikutnya: ${nextName} : ${hours}:${minutes}:${seconds}`;

        }, 1000);
    }

    // Fungsi utama untuk memuat jadwal (dari JSON lokal)
    async function loadJadwalSimple() {
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);

        if (countdownIntervalSimple) clearInterval(countdownIntervalSimple);
        countdownDivSimple.innerHTML = "Memuat...";

        let rawSchedule;
        let success = false;
        let todayData, nextData;

        try {
            // AMBIL FILE JSON LOKAL
            const res = await fetch('jadwal.json'); 
            if (!res.ok) throw new Error("Gagal memuat jadwal.json lokal.");
            
            rawSchedule = await res.json();
            
            // Cari jadwal hari ini dan besok
            todayData = findScheduleByDate(rawSchedule.schedule, today);
            nextData = findScheduleByDate(rawSchedule.schedule, tomorrow);
            
            if (todayData) {
                // Jadwal hari ini ditemukan
                success = true;
            } else if (nextData) {
                 // Jadwal hari ini terlewat/habis, gunakan jadwal besok (untuk Isya ke Subuh)
                 todayData = nextData;
                 success = true;
            } else {
                 throw new Error("Jadwal hari ini dan besok tidak ditemukan di JSON.");
            }
            
        } catch (error) {
            console.error("Error memuat/menganalisis JSON:", error);
            success = false;
        }

        if (!success) {
            useDefaultJadwal();
            // Jeda Stabilisasi 1 detik
            setTimeout(startCountdownSimple, 1000); 
            return; 
        }
        
        // DATA DITEMUKAN: Update tampilan dan global variables
        const currentData = todayData; 
        
        jadwalDivSimple.innerHTML = `
            <span style="color: yellow; font-weight: bold;">(JADWAL HARIAN)</span><br>
            Tanggal: <strong>${currentData.date}</strong><br>
            Subuh : ${currentData.Subuh} <span style="font-size: 12px;">(Sudah di-offset)</span><br>
            Terbit: ${currentData.Terbit} (Syuruq)<br>
            Dzuhur : ${currentData.Dzuhur}<br>
            Ashar : ${currentData.Ashar}<br>
            Maghrib : ${currentData.Maghrib}<br>
            Isya : ${currentData.Isya}
        `;

        window.prayerTimesSimple = {
            "Subuh": currentData.Subuh,
            "Dzuhur": currentData.Dzuhur,
            "Ashar": currentData.Ashar,
            "Maghrib": currentData.Maghrib,
            "Isya": currentData.Isya
        };
        // Atur tanggal jadwal ke tanggal yang benar-benar dimuat dari JSON
        window.prayerDateSimple = new Date(currentData.date); 

        // Jeda Stabilisasi 1 detik sebelum memulai countdown
        setTimeout(startCountdownSimple, 1000); 
    }

    // --- EVENT LISTENERS ---
    
    // Simpan pilihan suara ke localStorage
    voiceSelectSimple.addEventListener('change', function() {
        localStorage.setItem('selectedAdzanVoiceSimple', this.value);
        localStorage.setItem('selectedAdzanIndexSimple', this.selectedIndex);
        // Atur ulang sumber audio untuk tombol play
        const selectedOption = this.options[this.selectedIndex];
        audioSimple.src = this.value; 
        audioSimple.load();
    });

    // Pemicu tombol play manual
    btnPlaySimple.addEventListener('click', function() {
        // Pilihan Adzan normal
        let adzanSource = voiceSelectSimple.value; 
        
        // Jika tombol ditekan saat subuh, gunakan file subuh
        const nextPrayers = getNextPrayerTimesSimple(window.prayerDateSimple, window.prayerTimesSimple);
        if (nextPrayers.length > 0 && nextPrayers[0].name === "Subuh") {
             adzanSource = voiceSelectSimple.options[voiceSelectSimple.selectedIndex].getAttribute('data-subuh');
        }
        
        audioSimple.src = adzanSource;
        audioSimple.load();
        playAdzanSimple();
    });

    // --- INITIALIZATION ---

    // Muat pilihan suara yang tersimpan
    const savedIndex = localStorage.getItem('selectedAdzanIndexSimple');
    if (savedIndex !== null && voiceSelectSimple.options[savedIndex]) {
        voiceSelectSimple.selectedIndex = savedIndex;
        // Set audio source awal ke pilihan yang tersimpan
        audioSimple.src = voiceSelectSimple.value; 
        audioSimple.load();
    } else {
        // Set audio source awal ke default (Makkah)
        audioSimple.src = voiceSelectSimple.value; 
        audioSimple.load();
    }

    // Mulai proses pemuatan jadwal
    loadJadwalSimple();

</script>

</body>
</html>
